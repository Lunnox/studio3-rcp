<project name="customTargets overrides" default="noDefault">
	<import file="${eclipse.pdebuild.templates}/headless-build/customTargets.xml" />
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${builder}/ant-contrib/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<!-- ===================================================================== -->
	<!-- Steps to do before setup -->
	<!-- ===================================================================== -->
	<target name="preSetup">
		<antcall target="replaceVersions" />
	</target>

	<target name="replaceVersions">
		<tstamp>
			<format property="timestamp" pattern="dd MMMM yyyy, HH:mm:ss" locale="en" />
		</tstamp>
		<tstamp>
			<format property="short.timestamp" pattern="ddMMyyyyHHmmss" locale="en" />
		</tstamp>
		<echo message="Updating versions in feature and plugin manifests. Full version: ${version.full}, qualifier: ${build.revision}" />
		<!-- Replace very specific files (taken from our old build) -->
		<replace file="${buildDirectory}/plugins${product}" token="0.0.0.qualifier" value="${version.full}-${short.timestamp}" />
		<replace file="${buildDirectory}/plugins/com.aptana.rcp/plugin.properties" token="0.0.0.qualifier" value="${version.full}" />
		<replace file="${buildDirectory}/plugins/com.aptana.rcp/plugin.properties" token="%timestamp%" value="${timestamp}" />
		<replace file="${buildDirectory}/plugins/com.aptana.rcp/plugin.properties" token="%branch.name%" value="${env.GIT_BRANCH}" />
		<replace file="${buildDirectory}/plugins/com.aptana.rcp/plugin.properties" token="%build.tag%" value="${env.BUILD_TAG}" />
		<replace file="${buildDirectory}/features/com.aptana.feature.rcp/feature.properties" token="build.name" value="${build.name}" />
		<replace file="${buildDirectory}/features/com.aptana.feature.rcp/rootfiles/version.txt" token="0.0.0" value="${version.full}" />
		<replace file="${buildDirectory}/features/com.aptana.feature.rcp/rootfiles/version.txt" token=".qualifier" value="${build.revision}" />
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before the repositories are being processed -->
	<!-- ===================================================================== -->
	<target name="preProcessRepos">
		<p2.mirror destination="file:${repoBaseLocation}/mirrored">
			<source location="${studio3-feature.p2.repo}" />
			<iu id="com.aptana.feature.studio.feature.group" />
		</p2.mirror>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running package. -->
	<!-- ===================================================================== -->
	<target name="prePackage">
		<delete dir="${deploy.dir}" failonerror="false" />
		<mkdir dir="${deploy.dir}" />
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after the build is done. -->
	<!-- ===================================================================== -->
	<target name="postBuild">
		<antcall target="gatherLogs" />
		<antcall target="publish" />
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do to publish the build results -->
	<!-- ===================================================================== -->
	<target name="publish">
		<!-- Create the update site zip file -->
		<zip destfile="${builder}/${topLevelElementId}-${version.full}.zip">
			<fileset dir="${deploy.dir}" defaultexcludes="false" />
		</zip>
		<move file="${builder}/${topLevelElementId}-${version.full}.zip" todir="${deploy.dir}" />
		<!-- Rename the standalone zip files! -->
		<move todir="${deploy.dir}">
			<fileset dir="${buildDirectory}/${buildLabel}">
				<include name="*.zip"/>
			</fileset>
			<mapper type="regexp" from="^(\d+\-)(.+)\.zip$$" to="studio3.\2.zip"/>
		</move>
		<!-- Create a version.txt file containing the final version string -->
		<echo message="${version.full}" file="${deploy.dir}/version.txt" />
		<!-- copy over index.html file -->
		<move file="${builder}/update_site/index.html" tofile="${deploy.dir}/index.html" />
	</target>
</project>
