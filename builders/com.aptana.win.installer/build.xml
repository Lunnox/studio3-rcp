<project name="trunk" default="main">
	<property file="build.properties" />
	<property name="nsis.dir" location="${basedir}\windows-nsis" />
	<property name="makensis" value="${nsis.dir}\Tools\unicode_nsis\makensis.exe" />
	<property name="staging.dir" location="${basedir}\..\..\dist" />

	<target name="main">
		<echo message="Building NSIS installer" />
		<antcall target="move-exe" />
	</target>

	<target name="clean">
		<echo message="Cleaning old installer artifacts" />
		<delete file="${nsis.dir}/local_settings.nsh" />
		<delete file="${nsis.dir}/${target.exe.name}" />
		<delete file="${staging.dir}/${win.source.zip}"/>
		<delete dir="${staging.dir}"/>
	</target>

	<target name="init" depends="clean">
		<tstamp />
		<mkdir dir="${staging.dir}" />
		<get dest="${staging.dir}" src="${win.source.url}" />
	</target>

	<target name="unpack-archives" depends="init">
		<unzip src="${staging.dir}/${win.source.zip}" dest="${staging.dir}/win32" />
        <exec executable="cmd.exe" dir="${staging.dir}\win32" outputproperty="unzip.dir">
            <arg line="/c dir /A:D /B"/>
        </exec>
        <move file="${staging.dir}\win32\${unzip.dir}" tofile="${staging.dir}\win32"/>
        <delete dir="${staging.dir}\win32\${unzip.dir}"/>
	</target>

	<target name="build-nsis">
		<echo message="Creating local_settings.nsh file" />
		<echo file="${nsis.dir}/local_settings.nsh">!define INSTALL_FILES_ROOT "${staging.dir}\win32"
!define JRE_ROOT "${java.home}"</echo>
		<echo message="Calling makensis.exe" />
		<exec executable="${makensis}" failonerror="true">			
			<arg value='/XName ""${ProductName}""' />
			<arg value="${nsis.dir}\Aptana Studio.nsi" />
		</exec>
	</target>

	<target name="sign" depends="build-nsis">
		<echo message="Signing installer with sign tool" />
		<exec executable="${nsis.dir}\Tools\signtool\signtool.exe">
			<arg value="sign" />
			<arg value="/f ${signkey}" />
			<arg value='/d "Aptana Studio"' />
			<arg value="/du http://www.aptana.com" />
			<arg value="/t http://timestamp.verisign.com/scripts/timestamp.dll" />
			<arg value="/v" />
			<arg value="/p" />
			<arg value="iVviOEq5" />
			<arg value="${nsis.dir}\${target.exe.name}" />
		</exec>
	</target>
	
	<target name="move-exe" depends="sign">
		<move file="${nsis.dir}\${target.exe.name}" tofile="${staging.dir}\${target.exe.name}"/>
	</target>
</project>
